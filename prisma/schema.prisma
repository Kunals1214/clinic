generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  LAB_TECHNICIAN
  PHARMACIST
  BILLING_STAFF
  PATIENT
}

enum MFAMethod {
  SMS
  EMAIL
  TOTP
  BIOMETRIC
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  role              UserRole
  isActive          Boolean   @default(true)
  mfaEnabled        Boolean   @default(false)
  mfaMethods        MFAMethod[]
  mfaSecret         String?
  lastLogin         DateTime?
  loginAttempts     Int       @default(0)
  lockedUntil       DateTime?
  passwordChangedAt DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  provider          Provider?
  patient           Patient?
  auditLogs         AuditLog[]
  sessions          Session[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  ipAddress    String
  userAgent    String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================================================
// PROVIDER MANAGEMENT
// ============================================================================

enum ProviderSpecialty {
  GENERAL_PRACTICE
  INTERNAL_MEDICINE
  PEDIATRICS
  CARDIOLOGY
  DERMATOLOGY
  ORTHOPEDICS
  PSYCHIATRY
  NEUROLOGY
  ONCOLOGY
  RADIOLOGY
  PATHOLOGY
  EMERGENCY_MEDICINE
  SURGERY
  OBSTETRICS_GYNECOLOGY
  OPHTHALMOLOGY
  ENT
  ANESTHESIOLOGY
  PHYSICAL_THERAPY
}

model Provider {
  id                    String             @id @default(cuid())
  userId                String             @unique
  firstName             String
  lastName              String
  npiNumber             String             @unique
  deaNumber             String?
  licenseNumber         String
  licenseState          String
  licenseExpiryDate     DateTime
  specialty             ProviderSpecialty
  subSpecialties        String[]
  qualifications        String[]
  yearsOfExperience     Int
  phoneNumber           String
  photoUrl              String?
  bio                   String?
  acceptingNewPatients  Boolean            @default(true)
  consultationFee       Float
  isActive              Boolean            @default(true)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  user                  User               @relation(fields: [userId], references: [id])
  appointments          Appointment[]
  medicalRecords        MedicalRecord[]
  prescriptions         Prescription[]
  labOrders             LabOrder[]
  
  @@index([npiNumber])
  @@index([specialty])
  @@map("providers")
}

// ============================================================================
// PATIENT MANAGEMENT
// ============================================================================

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

model Patient {
  id                    String          @id @default(cuid())
  userId                String?         @unique
  mrn                   String          @unique // Medical Record Number
  firstName             String
  lastName              String
  middleName            String?
  dateOfBirth           DateTime
  gender                Gender
  bloodGroup            BloodGroup?
  maritalStatus         MaritalStatus?
  
  // Contact Information
  email                 String?
  phoneNumber           String
  alternatePhoneNumber  String?
  address               String
  city                  String
  state                 String
  zipCode               String
  country               String          @default("USA")
  
  // Emergency Contact
  emergencyContactName  String
  emergencyContactPhone String
  emergencyContactRelation String
  
  // Insurance Information
  insuranceProvider     String?
  insurancePolicyNumber String?
  insuranceGroupNumber  String?
  
  // Additional Information
  photoUrl              String?
  preferredLanguage     String          @default("English")
  ethnicity             String?
  occupation            String?
  ssn                   String?         // Encrypted
  
  // Medical Identifiers
  tags                  String[]        // VIP, high-risk, etc.
  
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  user                  User?           @relation(fields: [userId], references: [id])
  appointments          Appointment[]
  medicalRecords        MedicalRecord[]
  allergies             Allergy[]
  medications           Medication[]
  vitalSigns            VitalSign[]
  labOrders             LabOrder[]
  prescriptions         Prescription[]
  insuranceClaims       InsuranceClaim[]
  billingRecords        Billing[]
  documents             Document[]
  
  @@index([mrn])
  @@index([email])
  @@index([phoneNumber])
  @@map("patients")
}

// ============================================================================
// APPOINTMENT MANAGEMENT
// ============================================================================

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  PROCEDURE
  TELEMEDICINE
  EMERGENCY
  VACCINATION
  CHECKUP
  LAB_TEST
  IMAGING
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

model Appointment {
  id                  String            @id @default(cuid())
  patientId           String
  providerId          String
  appointmentDate     DateTime
  appointmentTime     String
  duration            Int               // in minutes
  type                AppointmentType
  status              AppointmentStatus @default(SCHEDULED)
  reason              String
  notes               String?
  isTelemedicine      Boolean           @default(false)
  telemedicineLink    String?
  
  // Check-in
  checkedInAt         DateTime?
  
  // Cancellation
  cancellationReason  String?
  cancelledAt         DateTime?
  
  // Reminders
  reminderSent        Boolean           @default(false)
  reminderSentAt      DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  patient             Patient           @relation(fields: [patientId], references: [id])
  provider            Provider          @relation(fields: [providerId], references: [id])
  medicalRecord       MedicalRecord?
  
  @@index([patientId])
  @@index([providerId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

// ============================================================================
// ELECTRONIC HEALTH RECORDS (EHR)
// ============================================================================

model MedicalRecord {
  id                String    @id @default(cuid())
  patientId         String
  providerId        String
  appointmentId     String?   @unique
  visitDate         DateTime
  
  // SOAP Notes
  subjective        String?   // Chief complaint, symptoms
  objective         String?   // Physical examination findings
  assessment        String?   // Diagnosis
  plan              String?   // Treatment plan
  
  // Clinical Notes
  clinicalNotes     String?
  
  // Diagnosis (ICD-10)
  primaryDiagnosis  String?
  secondaryDiagnoses String[]
  icdCodes          String[]
  
  // Vitals recorded during visit
  vitalSignsId      String?
  
  // Follow-up
  followUpDate      DateTime?
  followUpNotes     String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  patient           Patient   @relation(fields: [patientId], references: [id])
  provider          Provider  @relation(fields: [providerId], references: [id])
  appointment       Appointment? @relation(fields: [appointmentId], references: [id])
  
  @@index([patientId])
  @@index([providerId])
  @@index([visitDate])
  @@map("medical_records")
}

model VitalSign {
  id                String    @id @default(cuid())
  patientId         String
  recordedAt        DateTime  @default(now())
  
  // Vital measurements
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  heartRate         Int?      // bpm
  temperature       Float?    // Fahrenheit
  respiratoryRate   Int?      // breaths per minute
  oxygenSaturation  Float?    // percentage
  weight            Float?    // pounds
  height            Float?    // inches
  bmi               Float?    // calculated
  
  // Pain assessment
  painLevel         Int?      // 0-10 scale
  
  notes             String?
  recordedBy        String?   // Staff member who recorded
  
  createdAt         DateTime  @default(now())

  // Relations
  patient           Patient   @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([recordedAt])
  @@map("vital_signs")
}

model Allergy {
  id            String    @id @default(cuid())
  patientId     String
  allergen      String
  allergyType   String    // Drug, Food, Environmental
  reaction      String
  severity      String    // Mild, Moderate, Severe
  onsetDate     DateTime?
  notes         String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  patient       Patient   @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@map("allergies")
}

model Medication {
  id              String    @id @default(cuid())
  patientId       String
  medicationName  String
  dosage          String
  frequency       String
  route           String    // Oral, IV, IM, etc.
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean   @default(true)
  prescribedBy    String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  patient         Patient   @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([isActive])
  @@map("medications")
}

// ============================================================================
// LABORATORY MANAGEMENT
// ============================================================================

enum LabOrderStatus {
  ORDERED
  COLLECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

model LabOrder {
  id              String         @id @default(cuid())
  patientId       String
  providerId      String
  orderNumber     String         @unique
  testCodes       String[]
  testNames       String[]
  priority        String         @default("Routine") // Routine, Urgent, STAT
  status          LabOrderStatus @default(ORDERED)
  
  // Specimen information
  specimenType    String?
  specimenCollectedAt DateTime?
  
  notes           String?
  orderedAt       DateTime       @default(now())
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  patient         Patient        @relation(fields: [patientId], references: [id])
  provider        Provider       @relation(fields: [providerId], references: [id])
  results         LabResult[]
  
  @@index([patientId])
  @@index([providerId])
  @@index([orderNumber])
  @@index([status])
  @@map("lab_orders")
}

model LabResult {
  id              String    @id @default(cuid())
  labOrderId      String
  testName        String
  value           String
  unit            String?
  referenceRange  String?
  isAbnormal      Boolean   @default(false)
  isCritical      Boolean   @default(false)
  notes           String?
  resultDate      DateTime  @default(now())
  verifiedBy      String?
  verifiedAt      DateTime?
  createdAt       DateTime  @default(now())

  // Relations
  labOrder        LabOrder  @relation(fields: [labOrderId], references: [id])
  
  @@index([labOrderId])
  @@map("lab_results")
}

// ============================================================================
// PHARMACY & PRESCRIPTIONS
// ============================================================================

enum PrescriptionStatus {
  PENDING
  SENT
  FILLED
  CANCELLED
  EXPIRED
}

model Prescription {
  id                String              @id @default(cuid())
  patientId         String
  providerId        String
  rxNumber          String              @unique
  
  // Medication details
  medicationName    String
  genericName       String?
  strength          String
  dosageForm        String              // Tablet, Capsule, Liquid, etc.
  quantity          Int
  refills           Int
  daysSupply        Int
  
  // Instructions
  sig               String              // Prescription instructions
  route             String
  frequency         String
  
  // Pharmacy
  pharmacyName      String?
  pharmacyPhone     String?
  
  status            PrescriptionStatus  @default(PENDING)
  
  // Dates
  prescribedDate    DateTime            @default(now())
  expiryDate        DateTime
  lastFilledDate    DateTime?
  
  // Controlled substance
  isControlled      Boolean             @default(false)
  deaSchedule       String?
  
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  patient           Patient             @relation(fields: [patientId], references: [id])
  provider          Provider            @relation(fields: [providerId], references: [id])
  
  @@index([patientId])
  @@index([providerId])
  @@index([rxNumber])
  @@index([status])
  @@map("prescriptions")
}

// ============================================================================
// BILLING & FINANCIAL MANAGEMENT
// ============================================================================

enum BillingStatus {
  PENDING
  SUBMITTED
  PAID
  PARTIALLY_PAID
  DENIED
  APPEAL
  WRITTEN_OFF
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  CHECK
  INSURANCE
  PAYMENT_PLAN
}

model Billing {
  id                String         @id @default(cuid())
  patientId         String
  invoiceNumber     String         @unique
  serviceDate       DateTime
  
  // CPT codes (procedures)
  cptCodes          String[]
  cptDescriptions   String[]
  
  // ICD-10 codes (diagnoses)
  icd10Codes        String[]
  
  // Financial details
  subtotal          Float
  tax               Float          @default(0)
  discount          Float          @default(0)
  totalAmount       Float
  amountPaid        Float          @default(0)
  balance           Float
  
  status            BillingStatus  @default(PENDING)
  paymentMethod     PaymentMethod?
  
  // Insurance
  insuranceClaimId  String?
  
  notes             String?
  dueDate           DateTime?
  paidDate          DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  patient           Patient        @relation(fields: [patientId], references: [id])
  insuranceClaim    InsuranceClaim? @relation(fields: [insuranceClaimId], references: [id])
  payments          Payment[]
  
  @@index([patientId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("billing")
}

model Payment {
  id                String        @id @default(cuid())
  billingId         String
  amount            Float
  paymentMethod     PaymentMethod
  transactionId     String?
  paymentDate       DateTime      @default(now())
  notes             String?
  processedBy       String?
  
  createdAt         DateTime      @default(now())

  // Relations
  billing           Billing       @relation(fields: [billingId], references: [id])
  
  @@index([billingId])
  @@index([transactionId])
  @@map("payments")
}

model InsuranceClaim {
  id                String         @id @default(cuid())
  patientId         String
  claimNumber       String         @unique
  
  // Insurance details
  insuranceProvider String
  policyNumber      String
  groupNumber       String?
  
  // Claim details
  serviceDate       DateTime
  submittedDate     DateTime?
  processedDate     DateTime?
  
  // Amounts
  billedAmount      Float
  allowedAmount     Float?
  paidAmount        Float?
  patientResponsibility Float?
  
  status            BillingStatus  @default(PENDING)
  denialReason      String?
  
  // EDI
  edi837Sent        Boolean        @default(false)
  edi835Received    Boolean        @default(false)
  
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  patient           Patient        @relation(fields: [patientId], references: [id])
  billings          Billing[]
  
  @@index([patientId])
  @@index([claimNumber])
  @@index([status])
  @@map("insurance_claims")
}

// ============================================================================
// DOCUMENTS & FILES
// ============================================================================

enum DocumentType {
  LAB_REPORT
  IMAGING_REPORT
  PRESCRIPTION
  CONSENT_FORM
  INSURANCE_CARD
  ID_CARD
  MEDICAL_HISTORY
  REFERRAL
  OTHER
}

model Document {
  id              String        @id @default(cuid())
  patientId       String
  documentType    DocumentType
  fileName        String
  fileSize        Int           // in bytes
  mimeType        String
  filePath        String        // Encrypted storage path
  uploadedBy      String
  isEncrypted     Boolean       @default(true)
  description     String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  patient         Patient       @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([documentType])
  @@map("documents")
}

// ============================================================================
// AUDIT LOGGING (HIPAA COMPLIANCE)
// ============================================================================

enum AuditAction {
  LOGIN
  LOGOUT
  VIEW_PATIENT
  EDIT_PATIENT
  CREATE_PATIENT
  DELETE_PATIENT
  VIEW_MEDICAL_RECORD
  EDIT_MEDICAL_RECORD
  CREATE_MEDICAL_RECORD
  VIEW_LAB_RESULT
  PRESCRIBE_MEDICATION
  ACCESS_DOCUMENT
  EXPORT_DATA
  SYSTEM_CONFIG_CHANGE
  FAILED_LOGIN
  UNAUTHORIZED_ACCESS
}

model AuditLog {
  id              String      @id @default(cuid())
  userId          String
  action          AuditAction
  entityType      String?     // Patient, MedicalRecord, etc.
  entityId        String?
  ipAddress       String
  userAgent       String
  description     String
  metadata        Json?       // Additional context
  timestamp       DateTime    @default(now())

  // Relations
  user            User        @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

model SystemConfig {
  id              String    @id @default(cuid())
  key             String    @unique
  value           String
  description     String?
  isEncrypted     Boolean   @default(false)
  updatedBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("system_config")
}
